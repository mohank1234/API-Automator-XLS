{"version":3,"file":"index.js","names":["ContentType","Stage","Status","ReporterRuntime","createDefaultWriter","getEnvironmentLabels","getFrameworkLabel","getHostLabel","getLanguageLabel","getSuiteLabels","getThreadLabel","extractMeta","_AllureReporter_brand","WeakSet","AllureReporter","constructor","emitter","reporterConfig","options","_classPrivateMethodInitSpec","_defineProperty","Map","resultsDir","restConfig","_objectWithoutProperties","_excluded","currentCollection","collection","rootCollectionName","name","allureConfig","allureRuntime","_objectSpread","writer","registerEvents","on","onStart","bind","onBeforeItem","onItem","onPrerequest","onRequest","onTest","onAssertion","onConsole","onDone","currentScope","startScope","err","args","_args$executions$","currentTest","currentPmItem","pmItemsByAllureUuid","get","prerequest","executions","script","exec","join","pmItem","item","passed","failedAssertions","consoleLogs","itemGroup","parent","fullName","_assertClassBrand","_getFullName","call","testPath","_pathToItem","hostLabel","threadLabel","labels","links","events","startTest","titlePath","stage","RUNNING","updateTest","test","push","set","_requestData$headers","_requestData$body","_response$headers","requestData","requestDataURL","concat","method","url","rawDescription","request","description","testDescription","content","response","responseData","requestError","_attachString","testScript","length","headers","count","writeAttachment","undefined","_headerListToJsonBuffer","contentType","JSON","body","mode","raw","Buffer","from","TEXT","parameters","value","code","toString","excluded","descriptionHtml","replace","details","_escape","status","FAILED","FINISHED","statusDetails","message","trace","errorMsg","BROKEN","PASSED","stopTest","writeTest","_args$executions$2","execScript","testArgs","error","errName","errMsg","stepUuid","startStep","stopStep","level","messages","_args$response","req","respStream","stream","respBody","assertion","updateStep","step","stack","writeScope","forEachParent","chain","unshift","id","stringToAttach","Array","isArray","ret","all","forEach","h","key","stringify","val"],"sources":["../../src/index.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/unbound-method */\nimport type { EventEmitter } from \"events\";\nimport type { ConsoleEvent, Cursor, NewmanRunExecutionAssertion } from \"newman\";\nimport type { CollectionDefinition, Event, HeaderList, Item, Request, Response } from \"postman-collection\";\nimport { ContentType, Stage, Status } from \"allure-js-commons\";\nimport type { ReporterConfig } from \"allure-js-commons/sdk/reporter\";\nimport {\n  ReporterRuntime,\n  createDefaultWriter,\n  getEnvironmentLabels,\n  getFrameworkLabel,\n  getHostLabel,\n  getLanguageLabel,\n  getSuiteLabels,\n  getThreadLabel,\n} from \"allure-js-commons/sdk/reporter\";\nimport type { PmItem, RunningItem } from \"./model.js\";\nimport { extractMeta } from \"./utils.js\";\n\nclass AllureReporter {\n  allureRuntime: ReporterRuntime;\n  allureConfig: ReporterConfig;\n  runningItems: RunningItem[] = [];\n  currentCollection: CollectionDefinition;\n  pmItemsByAllureUuid: Map<string, PmItem> = new Map();\n  currentTest?: string;\n  currentScope?: string;\n  rootCollectionName?: string;\n\n  constructor(\n    emitter: EventEmitter,\n    reporterConfig: ReporterConfig,\n    options: {\n      collection: CollectionDefinition;\n    },\n  ) {\n    const { resultsDir, ...restConfig } = reporterConfig;\n\n    this.currentCollection = options.collection;\n    this.rootCollectionName = options.collection.name;\n    this.allureConfig = reporterConfig;\n    this.allureRuntime = new ReporterRuntime({\n      ...restConfig,\n      writer: createDefaultWriter({ resultsDir, emitter }),\n    });\n    this.registerEvents(emitter);\n  }\n\n  registerEvents(emitter: EventEmitter) {\n    emitter.on(\"start\", this.onStart.bind(this));\n    emitter.on(\"beforeItem\", this.onBeforeItem.bind(this));\n    emitter.on(\"item\", this.onItem.bind(this));\n    emitter.on(\"prerequest\", this.onPrerequest.bind(this));\n    emitter.on(\"request\", this.onRequest.bind(this));\n    emitter.on(\"test\", this.onTest.bind(this));\n    emitter.on(\"assertion\", this.onAssertion.bind(this));\n    emitter.on(\"console\", this.onConsole.bind(this));\n    emitter.on(\"done\", this.onDone.bind(this));\n  }\n\n  onStart() {\n    this.currentScope = this.allureRuntime.startScope();\n  }\n\n  onPrerequest(\n    err: any,\n    args: {\n      executions: Event[];\n    },\n  ) {\n    if (!this.currentTest) {\n      return;\n    }\n\n    const currentPmItem = this.pmItemsByAllureUuid.get(this.currentTest);\n\n    if (!currentPmItem) {\n      return;\n    }\n\n    currentPmItem.prerequest = args.executions[0]?.script?.exec?.join(\"\\n\");\n  }\n\n  onBeforeItem(err: any, args: { item: Item; cursor: Cursor }) {\n    const pmItem: PmItem = {\n      name: args.item.name,\n      passed: true,\n      failedAssertions: [],\n      consoleLogs: [],\n    };\n    const itemGroup = args.item.parent();\n    const item = args.item;\n    const fullName = this.#getFullName(item);\n    const testPath = this.#pathToItem(item);\n    const hostLabel = getHostLabel();\n    const threadLabel = getThreadLabel();\n    const { labels, links } = extractMeta(args.item.events);\n\n    this.currentTest = this.allureRuntime.startTest({\n      name: args.item.name,\n      fullName,\n      titlePath: testPath,\n      stage: Stage.RUNNING,\n      labels: [\n        getLanguageLabel(),\n        getFrameworkLabel(\"newman\"),\n        hostLabel,\n        threadLabel,\n        ...labels,\n        ...getEnvironmentLabels(),\n      ],\n      links,\n    });\n\n    this.allureRuntime.updateTest(this.currentTest, (test) => {\n      test.labels.push(...getSuiteLabels(testPath));\n    });\n\n    this.pmItemsByAllureUuid.set(this.currentTest, pmItem);\n\n    if (itemGroup && this.currentCollection !== itemGroup) {\n      this.currentCollection = itemGroup;\n    }\n  }\n\n  onItem(\n    err: any,\n    args: {\n      item: Item;\n    },\n  ) {\n    if (!this.currentTest) {\n      return;\n    }\n\n    const currentPmItem = this.pmItemsByAllureUuid.get(this.currentTest);\n\n    if (!currentPmItem) {\n      return;\n    }\n\n    const requestData = currentPmItem.requestData;\n    const requestDataURL = requestData && `${requestData.method} - ${requestData.url}`;\n    const rawDescription = args.item.request.description;\n    const testDescription = (typeof rawDescription === \"string\" ? rawDescription : rawDescription?.content) || \"\";\n    const response = currentPmItem.responseData;\n    const failedAssertions = currentPmItem.failedAssertions;\n    const requestError = currentPmItem.requestError;\n\n    if (currentPmItem.prerequest) {\n      this.#attachString(\"PreRequest\", currentPmItem.prerequest);\n    }\n\n    if (currentPmItem.testScript) {\n      this.#attachString(\"TestScript\", currentPmItem.testScript);\n    }\n\n    if (currentPmItem.consoleLogs.length) {\n      this.#attachString(\"ConsoleLogs\", currentPmItem.consoleLogs);\n    }\n\n    if (requestData?.headers && requestData?.headers?.count() > 0) {\n      this.allureRuntime.writeAttachment(\n        this.currentTest,\n        undefined,\n        \"Request Headers\",\n        this.#headerListToJsonBuffer(requestData.headers),\n        {\n          contentType: ContentType.JSON,\n        },\n      );\n    }\n\n    if (requestData?.body?.mode === \"raw\" && requestData.body.raw) {\n      this.#attachString(\"Request Body\", requestData.body.raw);\n    }\n\n    if (response?.headers && response?.headers?.count() > 0) {\n      this.allureRuntime.writeAttachment(\n        this.currentTest,\n        undefined,\n        \"Response Headers\",\n        this.#headerListToJsonBuffer(response.headers),\n        {\n          contentType: ContentType.JSON,\n        },\n      );\n    }\n\n    if (response?.body) {\n      this.allureRuntime.writeAttachment(\n        this.currentTest,\n        undefined,\n        \"Response Body\",\n        Buffer.from(response.body, \"utf-8\"),\n        {\n          contentType: ContentType.TEXT,\n        },\n      );\n    }\n\n    this.allureRuntime.updateTest(this.currentTest, (test) => {\n      if (requestDataURL) {\n        test.parameters.push({\n          name: \"Request\",\n          value: requestDataURL,\n        });\n      }\n\n      if (response?.code) {\n        test.parameters.push({\n          name: \"Response Code\",\n          value: response?.code.toString(),\n          excluded: true,\n        });\n      }\n\n      if (testDescription) {\n        const descriptionHtml = testDescription.replace(/[*]/g, \"\").replace(/\\n/g, \"<br>\");\n\n        test.description = testDescription;\n        test.descriptionHtml = descriptionHtml;\n      }\n    });\n\n    if (response && failedAssertions?.length) {\n      const details = this.#escape(`Response code: ${response.code}, status: ${response.status}`);\n\n      this.allureRuntime.updateTest(this.currentTest, (test) => {\n        test.status = Status.FAILED;\n        test.stage = Stage.FINISHED;\n        test.statusDetails = {\n          message: this.#escape(failedAssertions.join(\", \")),\n          trace: details,\n        };\n      });\n    } else if (requestError) {\n      const errorMsg = this.#escape(requestError);\n\n      this.allureRuntime.updateTest(this.currentTest, (test) => {\n        test.status = Status.BROKEN;\n        test.stage = Stage.FINISHED;\n        test.statusDetails = {\n          message: errorMsg,\n        };\n      });\n    } else {\n      this.allureRuntime.updateTest(this.currentTest, (test) => {\n        test.status = Status.PASSED;\n        test.stage = Stage.FINISHED;\n      });\n    }\n\n    this.allureRuntime.stopTest(this.currentTest);\n    this.allureRuntime.writeTest(this.currentTest);\n  }\n\n  onTest(err: any, args: { executions: Event[] }) {\n    if (!this.currentTest) {\n      return;\n    }\n\n    const currentPmItem = this.pmItemsByAllureUuid.get(this.currentTest);\n\n    if (!currentPmItem) {\n      return;\n    }\n\n    const execScript = args.executions[0]?.script?.exec?.join(\"\\n\");\n\n    if (!execScript) {\n      return;\n    }\n\n    currentPmItem.testScript = execScript;\n\n    // not typed postman-collection error property ?\n    const testArgs: any = args.executions[0];\n\n    if (!testArgs.error) {\n      return;\n    }\n\n    const errName: string = testArgs.error.name;\n    const errMsg: string = testArgs.error.message;\n\n    const stepUuid = this.allureRuntime.startStep(this.currentTest, undefined, {\n      name: errName,\n      status: Status.FAILED,\n      stage: Stage.FINISHED,\n      statusDetails: {\n        message: errMsg,\n      },\n    });\n\n    if (!stepUuid) {\n      // no such test running, ignore reporting\n      return;\n    }\n\n    currentPmItem.failedAssertions.push(errName);\n\n    this.allureRuntime.stopStep(stepUuid);\n  }\n\n  onConsole(err: any, args: ConsoleEvent) {\n    if (!this.currentTest) {\n      return;\n    }\n\n    const currentPmItem = this.pmItemsByAllureUuid.get(this.currentTest);\n\n    if (!currentPmItem || err) {\n      return;\n    }\n\n    if (args.level) {\n      currentPmItem.consoleLogs.push(`level: ${args.level}, messages: ${args.messages.toString()}`);\n    }\n  }\n\n  onRequest(\n    err: any,\n    args: {\n      request: Request;\n      response: Response;\n    },\n  ) {\n    if (!this.currentTest) {\n      return;\n    }\n\n    const currentPmItem = this.pmItemsByAllureUuid.get(this.currentTest);\n\n    if (!currentPmItem) {\n      return;\n    }\n\n    const req = args.request;\n    const url = req.url.toString(true);\n\n    currentPmItem.requestData = {\n      url: url,\n      method: req.method,\n      body: req.body,\n      headers: req.headers,\n    };\n\n    if (err) {\n      currentPmItem.passed = false;\n      currentPmItem.requestError = err.message;\n    }\n\n    if (!args.response) {\n      return;\n    }\n\n    const respStream = args?.response?.stream;\n    const respBody = respStream ? Buffer.from(respStream).toString() : \"\";\n\n    currentPmItem.responseData = {\n      status: args.response.status,\n      code: args.response.code,\n      body: respBody,\n      headers: args.response.headers,\n    };\n  }\n\n  onAssertion(err: any, args: NewmanRunExecutionAssertion) {\n    if (!this.currentTest) {\n      return;\n    }\n\n    const currentPmItem = this.pmItemsByAllureUuid.get(this.currentTest);\n\n    if (!currentPmItem) {\n      return;\n    }\n\n    const stepUuid = this.allureRuntime.startStep(this.currentTest, undefined, {\n      name: args.assertion,\n    });\n    if (!stepUuid) {\n      // no such test running, ignore reporting\n      return;\n    }\n\n    this.allureRuntime.updateStep(stepUuid, (step) => {\n      if (err && currentPmItem) {\n        currentPmItem.passed = false;\n        currentPmItem.failedAssertions.push(args.assertion);\n\n        step.statusDetails = {\n          message: err.message,\n          trace: err.stack,\n        };\n        step.status = Status.FAILED;\n      } else {\n        step.status = Status.PASSED;\n      }\n\n      step.stage = Stage.FINISHED;\n    });\n\n    this.allureRuntime.stopStep(stepUuid);\n  }\n\n  onDone() {\n    if (this.currentScope) {\n      this.allureRuntime.writeScope(this.currentScope);\n      this.currentScope = undefined;\n    }\n  }\n\n  #pathToItem(item: Item): string[] {\n    if (!item || !(typeof item.parent === \"function\") || !(typeof item.forEachParent === \"function\")) {\n      return [];\n    }\n\n    const chain: string[] = [];\n\n    item.forEachParent((parent) => {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      chain.unshift(parent.name || parent.id);\n    });\n\n    if (this.rootCollectionName) {\n      chain.unshift(this.rootCollectionName);\n    }\n    return chain;\n  }\n\n  #getFullName(item: Item): string {\n    const chain = this.#pathToItem(item);\n\n    return `${chain.join(\"/\")}#${item.name}`;\n  }\n\n  #attachString(name: string, value: string | string[]) {\n    const stringToAttach = Array.isArray(value) ? value.join(\"\\n\") : value;\n\n    if (!stringToAttach) {\n      return;\n    }\n\n    const content = Buffer.from(stringToAttach, \"utf-8\");\n\n    this.allureRuntime.writeAttachment(this.currentTest!, undefined, name, content, {\n      contentType: ContentType.TEXT,\n    });\n  }\n\n  #headerListToJsonBuffer(headers: HeaderList) {\n    const ret: { [k: string]: any } = {};\n\n    headers.all().forEach((h) => {\n      ret[h.key] = h.value;\n    });\n\n    return Buffer.from(JSON.stringify(ret, null, 4), \"utf-8\");\n  }\n\n  #escape(val: string) {\n    return val.replace(\"\\n\", \"\").replace(\"\\r\", \"\").replace('\"', '\"');\n  }\n}\n\nexport default AllureReporter;\n"],"mappings":"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","ignoreList":[]}